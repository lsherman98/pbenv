{{define "title"}}Environment Variables{{end}} {{define "page-title"}}Environment Variables{{end}} {{define
"page-description"}}Manage application environment variables{{end}} {{define
"body"}}

<div class="bg-[var(--baseColor)] rounded-lg shadow p-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
    <h2 class="text-xl font-bold text-[var(--primaryColor)]" style="font-family: var(--baseFontFamily)">
      Environment Variables
    </h2>
    <div class="flex gap-2">
      <button
        onclick="restartServer()"
        class="bg-[var(--infoColor)] text-white px-4 py-2 rounded-md hover:bg-[var(--primaryColor)] transition"
      >
        Restart Server
      </button>
      <button
        onclick="openAddModal()"
        class="bg-[var(--successColor)] text-white px-4 py-2 rounded-md hover:bg-[var(--primaryColor)] transition"
      >
        Add Variable
      </button>
    </div>
  </div>
  <div class="mb-4">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by key..."
      class="w-full px-4 py-2 border border-[var(--infoColor)] rounded-md bg-white shadow focus:outline-none focus:ring-2 focus:ring-[var(--infoColor)] placeholder:text-[var(--txtHintColor)]"
      onkeyup="filterTable()"
    />
  </div>
  <div class="w-full overflow-x-auto">
    <table id="envTable" class="w-full table-fixed bg-[var(--baseColor)] border border-[var(--baseAlt2Color)]">
      <thead>
        <tr class="bg-[var(--baseAlt1Color)] border-b border-[var(--baseAlt2Color)]">
          <th class="text-left px-6 py-3 font-semibold text-[var(--primaryColor)] text-sm w-1/4">Key</th>
          <th class="text-left px-6 py-3 font-semibold text-[var(--primaryColor)] text-sm w-3/5">Value</th>
          <th class="text-left px-6 py-3 font-semibold text-sm w-1/4" style="width: 150px">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div
  id="addModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--overlayColor)] bg-opacity-70 transition-opacity duration-200 hidden"
>
  <div class="bg-[var(--baseColor)] rounded-lg shadow-lg p-8 w-full max-w-md border border-[var(--baseAlt2Color)]">
    <h2 class="text-lg font-bold mb-4 text-[var(--primaryColor)]" style="font-family: var(--baseFontFamily)">
      Add Environment Variable
    </h2>
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1 text-[var(--primaryColor)]">Key</label>
      <input
        type="text"
        id="addKey"
        placeholder="VARIABLE_NAME"
        class="w-full px-3 py-2 border border-[var(--baseAlt2Color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--infoColor)] bg-[var(--baseAlt1Color)]"
      />
    </div>
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1 text-[var(--primaryColor)]">Value</label>
      <input
        type="text"
        id="addValue"
        placeholder="variable_value"
        class="w-full px-3 py-2 border border-[var(--baseAlt2Color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--infoColor)] bg-[var(--baseAlt1Color)]"
      />
    </div>
    <div id="addError" class="text-[var(--dangerColor)] text-sm mb-2" style="display: none"></div>
    <div class="flex gap-2 justify-end mt-4">
      <button
        onclick="addVar()"
        class="bg-[var(--successColor)] text-white px-4 py-2 rounded-md hover:bg-[var(--primaryColor)] transition"
      >
        Add
      </button>
      <button
        onclick="closeAddModal()"
        class="bg-[var(--baseAlt2Color)] text-[var(--primaryColor)] px-4 py-2 rounded-md hover:bg-[var(--baseAlt4Color)] transition"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<div
  id="editModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--overlayColor)] bg-opacity-70 transition-opacity duration-200 hidden"
>
  <div class="bg-[var(--baseColor)] rounded-lg shadow-lg p-8 w-full max-w-md border border-[var(--baseAlt2Color)]">
    <h2 class="text-lg font-bold mb-4 text-[var(--primaryColor)]" style="font-family: var(--baseFontFamily)">
      Edit Environment Variable
    </h2>
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1 text-[var(--primaryColor)]">Key</label>
      <input
        type="text"
        id="editKey"
        style="background: #f0f0f0"
        class="w-full px-3 py-2 border border-[var(--baseAlt2Color)] rounded-md bg-[var(--baseAlt1Color)] text-[var(--txtDisabledColor)]"
        readonly
      />
    </div>
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1 text-[var(--primaryColor)]">Value</label>
      <input
        type="text"
        id="editValue"
        class="w-full px-3 py-2 border border-[var(--baseAlt2Color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--infoColor)] bg-[var(--baseAlt1Color)]"
      />
    </div>
    <div id="editError" class="text-[var(--dangerColor)] text-sm mb-2" style="display: none"></div>
    <div class="flex gap-2 justify-end mt-4">
      <button
        onclick="updateVar()"
        class="bg-[var(--infoColor)] text-white px-4 py-2 rounded-md hover:bg-[var(--primaryColor)] transition"
      >
        Update
      </button>
      <button
        onclick="closeEditModal()"
        class="bg-[var(--baseAlt2Color)] text-[var(--primaryColor)] px-4 py-2 rounded-md hover:bg-[var(--baseAlt4Color)] transition"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<script>
  const SUPERUSER_TOKEN = JSON.parse(localStorage.getItem("__pb_superuser_auth__"))?.token;
  if (!SUPERUSER_TOKEN || JSON.parse(atob(SUPERUSER_TOKEN.split(".")[1])).exp < Math.round(Date.now() / 1000)) {
    window.location.href = window.location.origin + "/_/#/login";
  }

  async function fetchEnvVars() {
    fetch("/_/env/data", {
      headers: { Authorization: SUPERUSER_TOKEN },
    })
      .then((response) => response.json())
      .then((data) => {
        const tableBody = document.querySelector("#envTable tbody");
        tableBody.innerHTML = "";
        data.forEach((env) => {
          const row = document.createElement("tr");
          row.setAttribute("data-key", env.key);
          row.className = "hover:bg-[var(--baseAlt1Color)] transition";
          row.innerHTML = `
            <td class="px-6 py-3 border-b border-[var(--baseAlt2Color)] align-middle break-words"><span class="font-mono font-semibold text-[var(--primaryColor)]">${env.key}</span></td>
            <td class="px-6 py-3 border-b border-[var(--baseAlt2Color)] align-middle text-[var(--txtHintColor)] whitespace-normal break-words">${env.value}</td>
            <td class="px-6 py-3 border-b border-[var(--baseAlt2Color)] align-middle">
              <div class="flex gap-2">
                <button onclick="openEditModal('${env.key}', '${env.value}')" class="px-3 py-1 rounded-md bg-[var(--infoAltColor)] text-[var(--primaryColor)] hover:bg-[var(--infoColor)] hover:text-white transition text-sm font-medium">Edit</button>
                <button onclick="deleteVar('${env.key}')" class="px-3 py-1 rounded-md bg-[var(--dangerAltColor)] text-[var(--dangerColor)] hover:bg-[var(--dangerColor)] hover:text-white transition text-sm font-medium">Delete</button>
              </div>
            </td>
          `;
          tableBody.appendChild(row);
        });
      })
      .catch((error) => {
        console.error("Error fetching env vars:", error);
      });
  }

  function filterTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toUpperCase();
    const table = document.getElementById("envTable");
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
      const key = rows[i].getAttribute("data-key");
      if (key && key.toUpperCase().replace(/_/g, " ").indexOf(filter) > -1) {
        rows[i].style.display = "";
      } else {
        rows[i].style.display = "none";
      }
    }
  }

  function openAddModal() {
    document.getElementById("addModal").classList.remove("hidden");
    document.getElementById("addModal").classList.add("active");
    document.getElementById("addKey").value = "";
    document.getElementById("addValue").value = "";
    document.getElementById("addError").style.display = "none";
  }

  function closeAddModal() {
    document.getElementById("addModal").classList.add("hidden");
    document.getElementById("addModal").classList.remove("active");
  }

  function openEditModal(key, value) {
    document.getElementById("editModal").classList.remove("hidden");
    document.getElementById("editModal").classList.add("active");
    document.getElementById("editKey").value = key;
    document.getElementById("editValue").value = value;
    document.getElementById("editError").style.display = "none";
  }
  
  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
    document.getElementById("editModal").classList.remove("active");
  }

  async function addVar() {
    const key = document.getElementById("addKey").value.trim();
    const value = document.getElementById("addValue").value.trim();
    const errorDiv = document.getElementById("addError");

    if (!key) {
      errorDiv.textContent = "Key is required";
      errorDiv.style.display = "block";
      return;
    }

    fetch("/_/env", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: SUPERUSER_TOKEN,
      },
      body: JSON.stringify({ key, value }),
    })
      .then((response) => response.json().then((data) => ({ data, response })))
      .then(({ data, response }) => {
        if (!response.ok) {
          errorDiv.textContent = data.message || "Failed to add variable";
          errorDiv.style.display = "block";
          return;
        }
        closeAddModal();
        fetchEnvVars();
      })
      .catch((error) => {
        errorDiv.textContent = "Network error: " + error.message;
        errorDiv.style.display = "block";
      });
  }

  async function updateVar() {
    const key = document.getElementById("editKey").value;
    const value = document.getElementById("editValue").value.trim();
    const errorDiv = document.getElementById("editError");

    fetch(`/_/env/${encodeURIComponent(key)}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: SUPERUSER_TOKEN,
      },
      body: JSON.stringify({ value }),
    })
      .then((response) => response.json().then((data) => ({ data, response })))
      .then(({ data, response }) => {
        if (!response.ok) {
          errorDiv.textContent = data.message || "Failed to update variable";
          errorDiv.style.display = "block";
          return;
        }
        closeEditModal();
        fetchEnvVars();
      })
      .catch((error) => {
        errorDiv.textContent = "Network error: " + error.message;
        errorDiv.style.display = "block";
      });
  }

  async function deleteVar(key) {
    if (!confirm(`Are you sure you want to delete ${key}?`)) {
      return;
    }

    fetch(`/_/env/${encodeURIComponent(key)}`, {
      method: "DELETE",
      headers: { Authorization: SUPERUSER_TOKEN },
    })
      .then((response) => response.json().then((data) => ({ data, response })))
      .then(({ data, response }) => {
        if (!response.ok) {
          alert(data.message || "Failed to delete variable");
          return;
        }
        fetchEnvVars();
      })
      .catch((error) => {
        alert("Network error: " + error.message);
      });
  }

  async function restartServer() {
    if (!confirm(`Are you sure you want to restart the server?`)) {
        return;
    }

    fetch(`/_/restart`, {
      method: "POST",
      headers: { Authorization: SUPERUSER_TOKEN },
    })
      .then((response) => {
        if (!response.ok) {
            alert("Failed to restart server");
            return;
        }
        alert("Server is restarting...");
        window.location.reload();
      })
      .catch((error) => {
        alert("Network error: " + error.message);
      });
  }

  window.onclick = function (event) {
    const addModal = document.getElementById("addModal");
    const editModal = document.getElementById("editModal");
    if (event.target === addModal) {
      closeAddModal();
    }
    if (event.target === editModal) {
      closeEditModal();
    }
  };

  fetchEnvVars();
</script>
<style>
  #addModal.active,
  #editModal.active {
    display: flex !important;
  }
  #addModal,
  #editModal {
    display: none;
  }
</style>
{{end}}
